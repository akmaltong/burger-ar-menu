<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –∫–∞–º–µ—Ä—ã</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            background: #000;
            color: white;
        }
        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        video {
            width: 90%;
            max-width: 500px;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: #333;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        button:hover {
            background: #ff5252;
            transform: scale(1.05);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            max-width: 90%;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã AR Burger</h1>
        
        <div id="status" class="status info">
            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
        </div>
        
        <video id="cameraFeed" autoplay playsinline muted class="hidden"></video>
        
        <div class="controls">
            <button id="startCamera">üî¥ –ó–ê–ü–£–°–¢–ò–¢–¨ –ö–ê–ú–ï–†–£</button>
            <button id="stopCamera" disabled>‚èπ –û–°–¢–ê–ù–û–í–ò–¢–¨</button>
        </div>
        
        <div id="debug" style="margin-top: 20px; font-family: monospace; font-size: 14px; color: #aaa;"></div>
    </div>

    <script>
        const cameraFeed = document.getElementById('cameraFeed');
        const startBtn = document.getElementById('startCamera');
        const stopBtn = document.getElementById('stopCamera');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');
        let stream = null;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            debug.innerHTML += `[${time}] ${message}<br>`;
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }

        function updateStatus(text, type = 'info') {
            status.textContent = text;
            status.className = `status ${type}`;
        }

        async function initializeCamera() {
            try {
                log('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...');
                updateStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...', 'info');

                // –ö–æ–Ωstrainst –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const constraints = {
                    video: {
                        facingMode: { exact: "environment" }, // –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                log('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∞...');
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                log(`–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏: ${stream.getVideoTracks().length} –≤–∏–¥–µ–æ, ${stream.getAudioTracks().length} –∞—É–¥–∏–æ`);

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                cameraFeed.srcObject = stream;
                
                cameraFeed.onloadedmetadata = function(e) {
                    log(`–í–∏–¥–µ–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${cameraFeed.videoWidth}x${cameraFeed.videoHeight}`);
                    updateStatus('–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞! ‚úÖ', 'success');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    cameraFeed.play()
                        .then(() => {
                            log('–í–∏–¥–µ–æ –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è');
                            cameraFeed.classList.remove('hidden');
                            startBtn.disabled = true;
                            stopBtn.disabled = false;
                        })
                        .catch(err => {
                            log(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`);
                            updateStatus(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`, 'error');
                        });
                };

                cameraFeed.onerror = function(e) {
                    log(`–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: ${e.target.error.message}`);
                    updateStatus(`–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: ${e.target.error.message}`, 'error');
                };

            } catch (error) {
                log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.name} - ${error.message}`);
                
                // –ü–æ–ø—ã—Ç–∫–∞ —Å –¥—Ä—É–≥–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    log('–ü–æ–ø—ã—Ç–∫–∞ —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏...');
                    tryAlternativeConstraints();
                } else {
                    handleError(error);
                }
            }
        }

        async function tryAlternativeConstraints() {
            try {
                const basicConstraints = {
                    video: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                cameraFeed.srcObject = stream;
                
                cameraFeed.onloadedmetadata = function() {
                    cameraFeed.play()
                        .then(() => {
                            log('–í–∏–¥–µ–æ —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∑–∞–ø—É—â–µ–Ω–æ');
                            updateStatus('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ (–±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) ‚úÖ', 'success');
                            cameraFeed.classList.remove('hidden');
                            startBtn.disabled = true;
                            stopBtn.disabled = false;
                        });
                };
                
            } catch (error) {
                handleError(error);
            }
        }

        function handleError(error) {
            log(`–§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.name} - ${error.message}`);
            
            let message = '';
            switch(error.name) {
                case 'NotAllowedError':
                    message = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    break;
                case 'NotFoundError':
                    message = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã.';
                    break;
                case 'NotReadableError':
                    message = '–ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                    break;
                case 'AbortError':
                    message = '–ó–∞–ø—Ä–æ—Å –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω.';
                    break;
                default:
                    message = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
            
            updateStatus(message, 'error');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    log(`–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç—Ä–µ–∫: ${track.kind}`);
                });
                stream = null;
            }
            
            cameraFeed.srcObject = null;
            cameraFeed.classList.add('hidden');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
            log('–ö–∞–º–µ—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }

        // Event listeners
        startBtn.addEventListener('click', initializeCamera);
        stopBtn.addEventListener('click', stopCamera);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞...');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            const errorMsg = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç MediaDevices API';
            log(errorMsg);
            updateStatus(errorMsg, 'error');
            startBtn.disabled = true;
        } else {
            log('MediaDevices API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚úÖ');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            log('–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ö–∞–º–µ—Ä–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ HTTPS –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö');
        }

        log('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã.');
    </script>
</body>
</html>